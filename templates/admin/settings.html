{% extends "admin/base.html" %}

{% block title %}Configuration{% endblock %}
{% block page_title %}System Configuration{% endblock %}
{% block page_subtitle %}Manage system settings and API configurations{% endblock %}

{% block content %}
<!-- Configuration Overview Cards -->
<div class="row g-4 mb-5">
    <div class="col-lg-3 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3"
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 15px;">
                    <i class="fas fa-key text-white" style="font-size: 1.5rem;"></i>
                </div>
                <h6 class="fw-semibold">API Keys</h6>
                <p class="text-muted small mb-0">External service authentication</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3"
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 15px;">
                    <i class="fas fa-server text-white" style="font-size: 1.5rem;"></i>
                </div>
                <h6 class="fw-semibold">System</h6>
                <p class="text-muted small mb-0">Core system settings</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3"
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 15px;">
                    <i class="fas fa-database text-white" style="font-size: 1.5rem;"></i>
                </div>
                <h6 class="fw-semibold">Cache</h6>
                <p class="text-muted small mb-0">Performance optimization</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="d-inline-flex align-items-center justify-content-center mb-3"
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 15px;">
                    <i class="fas fa-shield-alt text-white" style="font-size: 1.5rem;"></i>
                </div>
                <h6 class="fw-semibold">Security</h6>
                <p class="text-muted small mb-0">Access control & protection</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Configuration Panel -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-cog me-2"></i>
                    <h5 class="mb-0">Configuration Management</h5>
                </div>
            </div>
            <div class="card-body">
                <!-- Modern Navigation Pills -->
                <div class="d-flex flex-wrap gap-2 mb-4" id="configTabs" role="tablist">
                    {% for category_key, category_name in categories.items() %}
                    <button class="btn btn-outline-primary {{ 'active' if loop.first else '' }}"
                        id="{{ category_key }}-tab" data-bs-toggle="tab" data-bs-target="#{{ category_key }}"
                        type="button" role="tab" aria-controls="{{ category_key }}"
                        aria-selected="{{ 'true' if loop.first else 'false' }}"
                        style="border-radius: 2rem; padding: 0.75rem 1.5rem;">
                        {% if category_key == 'api_keys' %}
                        <i class="fas fa-key me-2"></i>
                        {% elif category_key == 'system' %}
                        <i class="fas fa-server me-2"></i>
                        {% elif category_key == 'cache' %}
                        <i class="fas fa-database me-2"></i>
                        {% elif category_key == 'security' %}
                        <i class="fas fa-shield-alt me-2"></i>
                        {% elif category_key == 'monitoring' %}
                        <i class="fas fa-chart-line me-2"></i>
                        {% endif %}
                        {{ category_name }}
                    </button>
                    {% endfor %}
                </div>

                <!-- Tab Content -->
                <div class="tab-content" id="configTabContent">
                    {% for category_key, category_name in categories.items() %}
                    <div class="tab-pane fade {{ 'show active' if loop.first else '' }}" id="{{ category_key }}"
                        role="tabpanel">

                        <div class="mt-4">
                            <form method="POST" action="{{ url_for('admin_panel.update_settings') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <input type="hidden" name="category" value="{{ category_key }}">

                                {% set config = all_config.get(category_key, {}) %}
                                {% set values = config.get('values', {}) %}

                                <!-- API Keys Category -->
                                {% if category_key == 'api_keys' %}
                                <!-- API Key Input Fields -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="api_keys_google_safebrowsing_api_key" class="form-label">
                                                <i class="fab fa-google text-danger"></i>
                                                Google Safe Browsing API Key
                                            </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control"
                                                    name="api_keys_google_safebrowsing_api_key"
                                                    id="api_keys_google_safebrowsing_api_key"
                                                    placeholder="Enter Google Safe Browsing API key"
                                                    value="{{ values.get('google_safebrowsing_api_key', '') if values.get('google_safebrowsing_api_key') != '***ENCRYPTED***' else '' }}">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    onclick="togglePassword('api_keys_google_safebrowsing_api_key')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" type="button"
                                                    onclick="testApiKey('google_safebrowsing', 'api_keys_google_safebrowsing_api_key')">
                                                    <i class="fas fa-check"></i> Test
                                                </button>
                                            </div>
                                            <small class="form-text text-muted">
                                                Used for URL safety verification. Get your key from
                                                <a href="https://console.developers.google.com/" target="_blank">Google
                                                    Cloud Console</a>
                                            </small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="api_keys_perplexity_api_key" class="form-label">
                                                <i class="fas fa-brain text-info"></i>
                                                Perplexity API Key
                                            </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control"
                                                    name="api_keys_perplexity_api_key" id="api_keys_perplexity_api_key"
                                                    placeholder="Enter Perplexity API key"
                                                    value="{{ values.get('perplexity_api_key', '') if values.get('perplexity_api_key') != '***ENCRYPTED***' else '' }}">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    onclick="togglePassword('api_keys_perplexity_api_key')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" type="button"
                                                    onclick="testApiKey('perplexity', 'api_keys_perplexity_api_key')">
                                                    <i class="fas fa-check"></i> Test
                                                </button>
                                            </div>
                                            <small class="form-text text-muted">
                                                Used for AI-powered news, ad, and company verification. Get your key
                                                from
                                                <a href="https://www.perplexity.ai/" target="_blank">Perplexity AI</a>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Saved API Keys Table -->
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="text-secondary mb-3">
                                            <i class="fas fa-key"></i>
                                            Saved API Keys
                                        </h6>
                                        
                                        {% set has_keys = (values.get('google_safebrowsing_api_key') and values.get('google_safebrowsing_api_key') != '' and values.get('google_safebrowsing_api_key') != '***ENCRYPTED***') or (values.get('perplexity_api_key') and values.get('perplexity_api_key') != '' and values.get('perplexity_api_key') != '***ENCRYPTED***') or (values.get('google_safebrowsing_api_key') == '***ENCRYPTED***') or (values.get('perplexity_api_key') == '***ENCRYPTED***') %}
                                        
                                        {% if has_keys %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Service</th>
                                                        <th>API Key</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% if values.get('google_safebrowsing_api_key') and values.get('google_safebrowsing_api_key') != '' %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <i class="fab fa-google text-danger me-2"></i>
                                                                <div>
                                                                    <strong>Google Safe Browsing</strong>
                                                                    <br>
                                                                    <small class="text-muted">URL safety verification</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <code class="api-key-display">
                                                                {% if values.get('google_safebrowsing_api_key') == '***ENCRYPTED***' %}
                                                                    ****...****
                                                                {% elif values.get('google_safebrowsing_api_key') and values.get('google_safebrowsing_api_key')|length > 12 %}
                                                                    {{ values.get('google_safebrowsing_api_key')[:8] }}...{{ values.get('google_safebrowsing_api_key')[-4:] }}
                                                                {% else %}
                                                                    {{ values.get('google_safebrowsing_api_key') }}
                                                                {% endif %}
                                                            </code>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-secondary" id="google_safebrowsing_status_badge">
                                                                <i class="fas fa-question-circle"></i> Unknown
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary" 
                                                                    onclick="testApiKeyInTable('google_safebrowsing')"
                                                                    title="Test API Key">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger" 
                                                                    onclick="deleteApiKey('google_safebrowsing')"
                                                                    title="Delete API Key">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                    
                                                    {% if values.get('perplexity_api_key') and values.get('perplexity_api_key') != '' %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-brain text-info me-2"></i>
                                                                <div>
                                                                    <strong>Perplexity AI</strong>
                                                                    <br>
                                                                    <small class="text-muted">AI-powered verification</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <code class="api-key-display">
                                                                {% if values.get('perplexity_api_key') == '***ENCRYPTED***' %}
                                                                    ****...****
                                                                {% elif values.get('perplexity_api_key') and values.get('perplexity_api_key')|length > 12 %}
                                                                    {{ values.get('perplexity_api_key')[:8] }}...{{ values.get('perplexity_api_key')[-4:] }}
                                                                {% else %}
                                                                    {{ values.get('perplexity_api_key') }}
                                                                {% endif %}
                                                            </code>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-secondary" id="perplexity_status_badge">
                                                                <i class="fas fa-question-circle"></i> Unknown
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary" 
                                                                    onclick="testApiKeyInTable('perplexity')"
                                                                    title="Test API Key">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger" 
                                                                    onclick="deleteApiKey('perplexity')"
                                                                    title="Delete API Key">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="text-center py-5">
                                            <i class="fas fa-key text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
                                            <h6 class="text-muted mt-3">No API Keys Saved</h6>
                                            <p class="text-muted">Add your first API key using the form above to get started.</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- System Category -->
                                {% elif category_key == 'system' %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="system_debug_mode" class="form-label">Debug Mode</label>
                                            <select class="form-select" name="system_debug_mode" id="system_debug_mode">
                                                <option value="false" {{ 'selected' if not values.get('debug_mode',
                                                    False) else '' }}>Disabled</option>
                                                <option value="true" {{ 'selected' if values.get('debug_mode', False)
                                                    else '' }}>Enabled</option>
                                            </select>
                                            <small class="form-text text-muted">Enable detailed logging and error
                                                messages</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="system_log_level" class="form-label">Log Level</label>
                                            <select class="form-select" name="system_log_level" id="system_log_level">
                                                <option value="DEBUG" {{ 'selected' if values.get('log_level')=='DEBUG'
                                                    else '' }}>DEBUG</option>
                                                <option value="INFO" {{ 'selected' if values.get('log_level')=='INFO'
                                                    else '' }}>INFO</option>
                                                <option value="WARNING" {{ 'selected' if
                                                    values.get('log_level')=='WARNING' else '' }}>WARNING</option>
                                                <option value="ERROR" {{ 'selected' if values.get('log_level')=='ERROR'
                                                    else '' }}>ERROR</option>
                                            </select>
                                            <small class="form-text text-muted">Minimum log level to record</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="system_request_timeout" class="form-label">Request Timeout
                                                (seconds)</label>
                                            <input type="number" class="form-control" name="system_request_timeout"
                                                id="system_request_timeout"
                                                value="{{ values.get('request_timeout', 30) }}" min="5" max="300">
                                            <small class="form-text text-muted">Timeout for external API
                                                requests</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="system_maintenance_mode" class="form-label">Maintenance
                                                Mode</label>
                                            <select class="form-select" name="system_maintenance_mode"
                                                id="system_maintenance_mode">
                                                <option value="false" {{ 'selected' if not
                                                    values.get('maintenance_mode', False) else '' }}>Disabled</option>
                                                <option value="true" {{ 'selected' if values.get('maintenance_mode',
                                                    False) else '' }}>Enabled</option>
                                            </select>
                                            <small class="form-text text-muted">Enable to show maintenance message to
                                                users</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="system_maintenance_message" class="form-label">Maintenance
                                                Message</label>
                                            <textarea class="form-control" name="system_maintenance_message"
                                                id="system_maintenance_message"
                                                rows="3">{{ values.get('maintenance_message', 'System is under maintenance. Please try again later.') }}</textarea>
                                            <small class="form-text text-muted">Message shown to users during
                                                maintenance</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="system_max_request_size" class="form-label">Max Request
                                                Size</label>
                                            <input type="text" class="form-control" name="system_max_request_size"
                                                id="system_max_request_size"
                                                value="{{ values.get('max_request_size', '16MB') }}" placeholder="16MB">
                                            <small class="form-text text-muted">Maximum size for uploaded files and
                                                requests</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cache Category -->
                                {% elif category_key == 'cache' %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cache_default_timeout" class="form-label">Default Cache Timeout
                                                (seconds)</label>
                                            <input type="number" class="form-control" name="cache_default_timeout"
                                                id="cache_default_timeout"
                                                value="{{ values.get('default_timeout', 3600) }}" min="60" max="86400">
                                            <small class="form-text text-muted">Default cache expiration time</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="cache_cache_key_prefix" class="form-label">Cache Key
                                                Prefix</label>
                                            <input type="text" class="form-control" name="cache_cache_key_prefix"
                                                id="cache_cache_key_prefix"
                                                value="{{ values.get('cache_key_prefix', 'linksafety:') }}"
                                                placeholder="linksafety:">
                                            <small class="form-text text-muted">Prefix for all cache keys</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cache_max_cache_size" class="form-label">Max Cache Size</label>
                                            <input type="text" class="form-control" name="cache_max_cache_size"
                                                id="cache_max_cache_size"
                                                value="{{ values.get('max_cache_size', '100MB') }}" placeholder="100MB">
                                            <small class="form-text text-muted">Maximum cache size limit</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="cache_enable_cache_compression" class="form-label">Cache
                                                Compression</label>
                                            <select class="form-select" name="cache_enable_cache_compression"
                                                id="cache_enable_cache_compression">
                                                <option value="false" {{ 'selected' if not
                                                    values.get('enable_cache_compression', True) else '' }}>Disabled
                                                </option>
                                                <option value="true" {{ 'selected' if
                                                    values.get('enable_cache_compression', True) else '' }}>Enabled
                                                </option>
                                            </select>
                                            <small class="form-text text-muted">Compress cached data to save
                                                memory</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security Category -->
                                {% elif category_key == 'security' %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="security_admin_session_timeout" class="form-label">Admin Session
                                                Timeout (seconds)</label>
                                            <input type="number" class="form-control"
                                                name="security_admin_session_timeout"
                                                id="security_admin_session_timeout"
                                                value="{{ values.get('admin_session_timeout', 1800) }}" min="300"
                                                max="7200">
                                            <small class="form-text text-muted">Admin session expiration time</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="security_max_login_attempts" class="form-label">Max Login
                                                Attempts</label>
                                            <input type="number" class="form-control" name="security_max_login_attempts"
                                                id="security_max_login_attempts"
                                                value="{{ values.get('max_login_attempts', 5) }}" min="3" max="20">
                                            <small class="form-text text-muted">Maximum failed login attempts before
                                                lockout</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="security_login_attempt_window" class="form-label">Login Attempt
                                                Window (seconds)</label>
                                            <input type="number" class="form-control"
                                                name="security_login_attempt_window" id="security_login_attempt_window"
                                                value="{{ values.get('login_attempt_window', 900) }}" min="300"
                                                max="3600">
                                            <small class="form-text text-muted">Time window for counting failed
                                                attempts</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="security_enable_csrf_protection" class="form-label">CSRF
                                                Protection</label>
                                            <select class="form-select" name="security_enable_csrf_protection"
                                                id="security_enable_csrf_protection">
                                                <option value="false" {{ 'selected' if not
                                                    values.get('enable_csrf_protection', True) else '' }}>Disabled
                                                </option>
                                                <option value="true" {{ 'selected' if
                                                    values.get('enable_csrf_protection', True) else '' }}>Enabled
                                                </option>
                                            </select>
                                            <small class="form-text text-muted">Enable CSRF token validation</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Monitoring Category -->
                                {% elif category_key == 'monitoring' %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="monitoring_enable_metrics" class="form-label">Enable Metrics
                                                Collection</label>
                                            <select class="form-select" name="monitoring_enable_metrics"
                                                id="monitoring_enable_metrics">
                                                <option value="false" {{ 'selected' if not values.get('enable_metrics',
                                                    True) else '' }}>Disabled</option>
                                                <option value="true" {{ 'selected' if values.get('enable_metrics', True)
                                                    else '' }}>Enabled</option>
                                            </select>
                                            <small class="form-text text-muted">Collect system performance
                                                metrics</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="monitoring_metrics_retention_days" class="form-label">Metrics
                                                Retention (days)</label>
                                            <input type="number" class="form-control"
                                                name="monitoring_metrics_retention_days"
                                                id="monitoring_metrics_retention_days"
                                                value="{{ values.get('metrics_retention_days', 30) }}" min="1"
                                                max="365">
                                            <small class="form-text text-muted">How long to keep metrics data</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <h6 class="text-secondary">Alert Thresholds</h6>
                                        {% set thresholds = values.get('alert_thresholds', {}) %}

                                        <div class="mb-3">
                                            <label for="monitoring_error_rate" class="form-label">Error Rate
                                                Threshold</label>
                                            <input type="number" class="form-control" name="monitoring_error_rate"
                                                id="monitoring_error_rate"
                                                value="{{ thresholds.get('error_rate', 0.05) }}" step="0.01" min="0"
                                                max="1">
                                            <small class="form-text text-muted">Alert when error rate exceeds this value
                                                (0.05 = 5%)</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="monitoring_response_time" class="form-label">Response Time
                                                Threshold (seconds)</label>
                                            <input type="number" class="form-control" name="monitoring_response_time"
                                                id="monitoring_response_time"
                                                value="{{ thresholds.get('response_time', 5.0) }}" step="0.1" min="0.1"
                                                max="60">
                                            <small class="form-text text-muted">Alert when response time exceeds this
                                                value</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Save Button -->
                                <div class="d-flex justify-content-between mt-4">
                                    <div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Last updated: {{ config.get('updated_at', 'Never')[:19] if
                                            config.get('updated_at') else 'Never' }}
                                            {% if config.get('updated_by') %}by {{ config.get('updated_by') }}{% endif
                                            %}
                                        </small>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save {{ category_name }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration History -->
{% if config_history %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history"></i>
                    Recent Configuration Changes
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Category</th>
                                <th>Setting</th>
                                <th>Value</th>
                                <th>Updated By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for change in config_history %}
                            <tr>
                                <td><small>{{ change.timestamp[:19] }}</small></td>
                                <td>
                                    <span class="badge bg-secondary">{{ change.category }}</span>
                                </td>
                                <td>{{ change.key }}</td>
                                <td>
                                    <code>{{ change.value if change.value != '***' else '***ENCRYPTED***' }}</code>
                                </td>
                                <td>{{ change.updated_by }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* Modern pill navigation styling */
    .btn-outline-primary.active {
        background: linear-gradient(135deg, var(--admin-primary), var(--admin-primary-hover));
        border-color: var(--admin-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn-outline-primary:not(.active):hover {
        background: rgba(79, 70, 229, 0.1);
        border-color: var(--admin-primary);
        color: var(--admin-primary);
        transform: translateY(-1px);
    }

    /* Enhanced form styling */
    .form-label {
        font-weight: 600;
        color: var(--admin-light);
        margin-bottom: 0.75rem;
    }

    .form-label i {
        margin-right: 0.5rem;
    }

    .form-control,
    .form-select {
        background: rgba(17, 24, 39, 0.8);
        border: 2px solid var(--admin-border);
        border-radius: 0.75rem;
        color: var(--admin-light);
        padding: 0.875rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        background: rgba(17, 24, 39, 0.95);
        border-color: var(--admin-primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        color: var(--admin-light);
    }

    .form-text {
        color: var(--admin-muted);
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    /* Input group styling */
    .input-group .btn {
        border-radius: 0;
        border: 2px solid var(--admin-border);
        border-left: none;
    }

    .input-group .btn:last-child {
        border-radius: 0 0.75rem 0.75rem 0;
    }

    .input-group .form-control {
        border-right: none;
        border-radius: 0.75rem 0 0 0.75rem;
    }

    /* Service status cards */
    .border-left-primary {
        border-left: 4px solid var(--admin-primary) !important;
        background: rgba(79, 70, 229, 0.05);
    }

    .border-left-info {
        border-left: 4px solid var(--admin-info) !important;
        background: rgba(59, 130, 246, 0.05);
    }

    .border-left-success {
        border-left: 4px solid var(--admin-success) !important;
        background: rgba(16, 185, 129, 0.05);
    }

    .border-left-warning {
        border-left: 4px solid var(--admin-warning) !important;
        background: rgba(245, 158, 11, 0.05);
    }

    /* Enhanced button styling */
    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-info {
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-outline-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn-outline-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .btn-outline-info:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Tab content styling */
    .tab-pane {
        animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Configuration history table */
    .table {
        background: rgba(31, 41, 55, 0.6);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .table th {
        background: rgba(79, 70, 229, 0.1);
        border-color: var(--admin-border);
        font-weight: 600;
        color: var(--admin-light);
    }

    .table td {
        border-color: var(--admin-border);
        color: var(--admin-light);
    }

    .table-hover tbody tr:hover {
        background: rgba(79, 70, 229, 0.05);
    }

    /* Badge styling */
    .badge {
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
    }

    /* Alert styling for API test results */
    .alert {
        border: none;
        border-radius: 0.75rem;
        backdrop-filter: blur(10px);
        border-left: 4px solid;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        border-left-color: var(--admin-success);
        color: #d1fae5;
    }

    .alert-danger {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: var(--admin-danger);
        color: #fecaca;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .d-flex.flex-wrap.gap-2 {
            flex-direction: column;
        }

        .btn-outline-primary {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Manual tab functionality
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // Function to show a specific tab
        function showTab(targetId, activeButton) {
            // Hide all tab panes
            tabPanes.forEach(pane => {
                pane.classList.remove('show', 'active');
                pane.style.display = 'none';
            });

            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            // Show target tab pane
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                targetPane.style.display = 'block';
                setTimeout(() => {
                    targetPane.classList.add('show', 'active');
                }, 10);
            }

            // Set active button
            activeButton.classList.add('active');
            activeButton.setAttribute('aria-selected', 'true');
        }

        // Add click event listeners to tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-bs-target').substring(1); // Remove # from target
                showTab(targetId, this);
            });
        });

        // Initialize - show first tab
        if (tabButtons.length > 0) {
            const firstButton = tabButtons[0];
            const firstTargetId = firstButton.getAttribute('data-bs-target').substring(1);
            showTab(firstTargetId, firstButton);
        }
    });

    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        const icon = button.querySelector('i');

        if (field.type === 'password') {
            field.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            field.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

    function testApiKey(service, fieldId) {
        const apiKey = document.getElementById(fieldId).value.trim();
        if (!apiKey) {
            alert('Please enter an API key first');
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;

        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token }}');
        formData.append('service', service);
        formData.append('api_key', apiKey);

        fetch('{{ url_for("admin_panel.test_api_key") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                const alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
                const icon = data.status === 'success' ? 'fa-check' : 'fa-times';

                // Show result
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-2`;
                alertDiv.innerHTML = `
                <i class="fas ${icon}"></i> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

                button.parentNode.appendChild(alertDiv);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            })
            .catch(error => {
                console.error('Error testing API key:', error);
                alert('Error testing API key: ' + error.message);
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function testApiKeyInTable(service) {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        const statusBadge = document.getElementById(service + '_status_badge');

        fetch(`{{ url_for("admin_panel.test_external_service", service="") }}${service}`)
            .then(response => response.json())
            .then(data => {
                const badgeClass = data.status === 'success' ? 'bg-success' : 'bg-danger';
                const icon = data.status === 'success' ? 'fa-check-circle' : 'fa-times-circle';
                const text = data.status === 'success' ? 'Working' : 'Failed';

                statusBadge.className = `badge ${badgeClass}`;
                statusBadge.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
            })
            .catch(error => {
                console.error('Error testing API key:', error);
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '<i class="fas fa-times-circle"></i> Error';
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function deleteApiKey(service) {
        if (!confirm(`Are you sure you want to delete the ${service.replace('_', ' ')} API key?`)) {
            return;
        }

        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token }}');
        formData.append('action', 'delete_api_key');
        formData.append('service', service);

        fetch('{{ url_for("admin_panel.delete_api_key") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload page to show updated table
                    location.reload();
                } else {
                    alert('Error deleting API key: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting API key:', error);
                alert('Error deleting API key: ' + error.message);
            });
    }

    // Form validation
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function (e) {
            const requiredFields = form.querySelectorAll('input[required], select[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields');
            }
        });
    });
</script>
{% endblock %}