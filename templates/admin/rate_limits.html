{% extends "admin/base.html" %}

{% block title %}Rate Limits{% endblock %}
{% block page_title %}Rate Limiting Configuration{% endblock %}

{% block content %}
<div class="row">
    <!-- Rate Limit Configuration -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-clock"></i>
                    Rate Limit Settings
                </h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="globalToggle" {{ 'checked' if
                        current_config.enabled else '' }}>
                    <label class="form-check-label" for="globalToggle">
                        Rate Limiting {{ 'Enabled' if current_config.enabled else 'Disabled' }}
                    </label>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_panel.update_rate_limits') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <!-- Global Enable/Disable -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="enabled" id="enabled" {{ 'checked' if
                                current_config.enabled else '' }}>
                            <label class="form-check-label" for="enabled">
                                <strong>Enable Rate Limiting</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            When disabled, all rate limits are bypassed (not recommended for production)
                        </small>
                    </div>

                    <hr>

                    <!-- Endpoint Rate Limits -->
                    <h5 class="mb-3">Endpoint Rate Limits</h5>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_check_url" class="form-label">
                                    <i class="fas fa-link text-info"></i>
                                    URL Safety Check
                                </label>
                                <input type="text" class="form-control" name="limit_check_url" id="limit_check_url"
                                    value="{{ current_config.limits.check_url or '50 per minute' }}"
                                    placeholder="50 per minute">
                                <small class="form-text text-muted">Format: "number per unit" (e.g., "50 per
                                    minute")</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_verify_news" class="form-label">
                                    <i class="fas fa-newspaper text-warning"></i>
                                    News Verification
                                </label>
                                <input type="text" class="form-control" name="limit_verify_news" id="limit_verify_news"
                                    value="{{ current_config.limits.verify_news or '30 per minute' }}"
                                    placeholder="30 per minute">
                                <small class="form-text text-muted">AI-powered verification (more resource
                                    intensive)</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_verify_ad" class="form-label">
                                    <i class="fas fa-ad text-danger"></i>
                                    Ad Verification
                                </label>
                                <input type="text" class="form-control" name="limit_verify_ad" id="limit_verify_ad"
                                    value="{{ current_config.limits.verify_ad or '30 per minute' }}"
                                    placeholder="30 per minute">
                                <small class="form-text text-muted">Advertisement trustworthiness analysis</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_verify_company" class="form-label">
                                    <i class="fas fa-building text-success"></i>
                                    Company Verification
                                </label>
                                <input type="text" class="form-control" name="limit_verify_company"
                                    id="limit_verify_company"
                                    value="{{ current_config.limits.verify_company or '30 per minute' }}"
                                    placeholder="30 per minute">
                                <small class="form-text text-muted">Company legitimacy verification</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_process_screenshot" class="form-label">
                                    <i class="fas fa-image text-secondary"></i>
                                    Screenshot Processing
                                </label>
                                <input type="text" class="form-control" name="limit_process_screenshot"
                                    id="limit_process_screenshot"
                                    value="{{ current_config.limits.process_screenshot or '10 per minute' }}"
                                    placeholder="10 per minute">
                                <small class="form-text text-muted">OCR + verification (most resource intensive)</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="limit_global" class="form-label">
                                    <i class="fas fa-globe text-primary"></i>
                                    Global Limit
                                </label>
                                <input type="text" class="form-control" name="limit_global" id="limit_global"
                                    value="{{ current_config.limits.global or '1000 per hour' }}"
                                    placeholder="1000 per hour">
                                <small class="form-text text-muted">Overall limit across all endpoints</small>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Valid time units: second, minute, hour, day, month, year
                            </small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetToDefaults()">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Current Status & Statistics -->
    <div class="col-lg-4">
        <!-- Current Status -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-tachometer-alt"></i>
                    Current Status
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Rate Limiting:</span>
                        <span class="badge bg-{{ 'success' if current_config.enabled else 'danger' }}">
                            {{ 'Enabled' if current_config.enabled else 'Disabled' }}
                        </span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Storage Backend:</span>
                        <span class="badge bg-{{ 'success' if current_config.source == 'redis' else 'warning' }}">
                            {{ current_config.source.title() }}
                        </span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Last Updated:</span>
                        <small class="text-muted">
                            {% if current_config.updated_at %}
                            {{ current_config.updated_at[:19] }}
                            {% else %}
                            Never
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Statistics -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-bar"></i>
                    Usage Statistics
                </h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow">
                        <form method="POST" action="{{ url_for('admin_panel.reset_rate_limit_stats') }}"
                            class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="dropdown-item"
                                onclick="return confirm('Reset all statistics?')">
                                <i class="fas fa-trash"></i> Reset All Stats
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if usage_stats %}
                {% for endpoint, stats in usage_stats.items() %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <small class="font-weight-bold">{{ endpoint.replace('_', ' ').title() }}</small>
                        <small class="text-muted">
                            <form method="POST" action="{{ url_for('admin_panel.reset_rate_limit_stats') }}"
                                class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <input type="hidden" name="endpoint" value="{{ endpoint }}">
                                <button type="submit" class="btn btn-link btn-sm p-0 text-muted"
                                    onclick="return confirm('Reset stats for {{ endpoint }}?')">
                                    <i class="fas fa-trash fa-xs"></i>
                                </button>
                            </form>
                        </small>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-success">
                                <i class="fas fa-check"></i> {{ stats.requests or 0 }} requests
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-danger">
                                <i class="fas fa-times"></i> {{ stats.violations or 0 }} violations
                            </small>
                        </div>
                    </div>
                    {% if stats.requests > 0 %}
                    {% set violation_percentage = (stats.violations / stats.requests * 100) if stats.requests > 0 else 0
                    %}
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-danger" role="progressbar"
                            style="width: {{ violation_percentage }}%">
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted text-center">
                    <i class="fas fa-chart-bar fa-2x mb-2"></i><br>
                    No usage statistics available
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Recent Violations -->
        {% if recent_violations %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Recent Violations
                </h6>
            </div>
            <div class="card-body">
                {% for violation in recent_violations %}
                <div class="mb-2 pb-2 border-bottom">
                    <div class="d-flex justify-content-between">
                        <small class="font-weight-bold">{{ violation.endpoint }}</small>
                        <small class="text-muted">{{ violation.timestamp[:19] }}</small>
                    </div>
                    <small class="text-muted">IP: {{ violation.ip_address }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function resetToDefaults() {
        if (confirm('Reset all rate limits to default values?')) {
            document.getElementById('limit_check_url').value = '50 per minute';
            document.getElementById('limit_verify_news').value = '30 per minute';
            document.getElementById('limit_verify_ad').value = '30 per minute';
            document.getElementById('limit_verify_company').value = '30 per minute';
            document.getElementById('limit_process_screenshot').value = '10 per minute';
            document.getElementById('limit_global').value = '1000 per hour';
        }
    }

    // Real-time validation
    document.querySelectorAll('input[name^="limit_"]').forEach(function (input) {
        input.addEventListener('blur', function () {
            const value = this.value.trim();
            if (value && !validateLimitFormat(value)) {
                this.classList.add('is-invalid');
                if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Invalid format. Use "number per unit" (e.g., "50 per minute")';
                    this.parentNode.appendChild(feedback);
                }
            } else {
                this.classList.remove('is-invalid');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.remove();
                }
            }
        });
    });

    function validateLimitFormat(limitString) {
        const parts = limitString.toLowerCase().split(' ');
        if (parts.length !== 3) return false;

        // Check if first part is a number
        if (isNaN(parseInt(parts[0]))) return false;

        // Check if second part is 'per'
        if (parts[1] !== 'per') return false;

        // Check if third part is a valid time unit
        const validUnits = ['second', 'minute', 'hour', 'day', 'month', 'year'];
        return validUnits.includes(parts[2]);
    }

    // Auto-refresh statistics every 30 seconds
    setInterval(function () {
        location.reload();
    }, 30000);
</script>
{% endblock %}